[http.middlewares]
  [http.middlewares.https_redirect.redirectScheme]
    scheme = "https"
    permanent = true

  [http.middlewares.dashboard_auth.basicauth]
    users = ["{{ env 'TRAEFIK_DASHBOARD_USER' }}:{{ env 'TRAEFIK_DASHBOARD_PASSWORD_HASH' }}"]
    removeHeader = true

[http.routers]
  # --- ACME HTTP-01: bypass con prioridad alt√≠sima en :80
  [http.routers.acme-http01]
    rule = 'PathPrefix(`/.well-known/acme-challenge/`)'
    entryPoints = ["web"]
    service = "noop@internal"
    priority = 100000

  # --- Dashboard SOLO por HTTPS (nada en HTTP)
  [http.routers.traefik-dashboard]
    rule = "Host(`{{ env 'TRAEFIK_DASHBOARD_HOST' }}`)"
    entryPoints = ["websecure"]
    service = "api@internal"
    middlewares = ["dashboard_auth"]
    [http.routers.traefik-dashboard.tls]
      certResolver = "leresolver"

  [http.routers.traefik-dashboard-http]
    rule = "Host(`{{ env 'TRAEFIK_DASHBOARD_HOST' }}`)"
    entryPoints = ["web"]
    service = "api@internal"
    middlewares = ["https_redirect"]
